"use strict";(self.webpackChunk_nand2tetris_web=self.webpackChunk_nand2tetris_web||[]).push([[331],{3478:(t,e,s)=>{s.d(e,{N:()=>c});var n=s(864),i=s(6845),r=s(2869);const o={Enter:128,Backspace:129,ArrowLeft:130,ArrowUp:131,ArrowRight:132,ArrowDown:133,Home:134,End:135,PageUp:136,PageDown:137,Insert:138,Delete:139,Escape:140,F1:141,F2:142,F3:143,F4:144,F5:145,F6:146,F7:147,F8:148,F9:149,F10:150,F11:151,F12:152},a={ArrowLeft:"L-arrow",ArrowUp:"U-arrow",ArrowRight:"R-arrow",ArrowDown:"D-arrow"};const c=t=>{let{keyboard:e,update:s}=t;const[c,h]=(0,i.useState)(!1),[u,l]=(0,i.useState)(""),[p,d]=(0,i.useState)(e.getKey());let m=0;const g=t=>{if(!c)return;l(function(t){return a[t]??t}(t.key));const e=function(t){const e=o[t.key];if(void 0!==e)return e;if(1===t.key.length){const e=t.key.charCodeAt(0);if(e>=32&&e<=126)return e}return 0}(t);e!==m&&(b(e),s?.())},f=t=>{c&&(m=0,e.clearKey(),s?.(),d(e.getKey()),l(""))},b=t=>{0!==t&&(e.setKey(t),d(e.getKey()),m=t)};return(0,i.useEffect)((()=>(window.addEventListener("keydown",g),window.addEventListener("keyup",f),()=>{window.removeEventListener("keydown",g),window.removeEventListener("keyup",f)}))),(0,n.jsxs)("div",{className:"flex row align-baseline",children:[(0,n.jsx)("div",{className:"flex-2",children:(0,n.jsx)(r.y,{name:"Key",bits:p})}),(0,n.jsxs)("div",{className:"flex-2",children:["Char: ",u]}),(0,n.jsx)("div",{className:"flex-3",children:(0,n.jsx)("button",{onClick:()=>{h(!c)},children:(c?"Disable":"Enable")+" Keyboard"})})]})}},2869:(t,e,s)=>{s.d(e,{y:()=>r});var n=s(864),i=s(5150);const r=t=>{let{name:e,bits:s}=t;return(0,n.jsxs)("div",{children:[e,": ",(0,i.E_)(s)]})}},8963:(t,e,s)=>{s.d(e,{l:()=>h});var n=s(864),i=s(7239),r=s(6845),o=s(5554);const a="white";function c(t,e,s,n){const i=4*(512*s+e),r=n===a?255:0;t[i]=r,t[i+1]=r,t[i+2]=r,t[i+3]=255}const h=t=>{let{memory:e}=t;const s=(0,r.useRef)(),h=(0,r.useCallback)((()=>{const t=s.current?.getContext("2d")??void 0;t&&function(t,e){const s=(0,i.kP)(t.getImageData(0,0,512,256),"Failed to create Context2d");for(let i=0;i<512;i++)for(let t=0;t<256;t++){const o=(n=i,r=t,0===(e.get(32*r+(n/16|0))&1<<n%16)?a:"black");c(s.data,i,t,o)}var n,r;t.putImageData(s,0,0)}(t,e)}),[e]),u=(0,r.useCallback)((t=>{s.current=t??void 0,h()}),[s,h]);return(0,o.RC)(h),(0,o._W)((()=>{s.current?.getContext("2d")?.clearRect(0,0,s.current.width,s.current.height)})),(0,n.jsxs)("article",{className:"panel",children:[(0,n.jsx)("header",{children:"Screen"}),(0,n.jsx)("main",{style:{backgroundColor:"var(--code-background-color)"},children:(0,n.jsx)("figure",{style:{width:"100%",maxWidth:"512px",boxSizing:"content-box",marginInline:"auto",margin:"auto",borderTop:"2px solid gray",borderLeft:"2px solid gray",borderBottom:"2px solid lightgray",borderRight:"2px solid lightgray"},children:(0,n.jsx)("canvas",{ref:u,width:512,height:256})})})]})}},5554:(t,e,s)=>{s.d(e,{RC:()=>a,_W:()=>c,uY:()=>u});var n=s(864),i=s(6845),r=s(554),o=s(5424);function a(t){(0,i.useEffect)((()=>{const e=o.S.get().frame$.subscribe((()=>{t()}));return()=>e.unsubscribe()}),[t])}function c(t){(0,i.useEffect)((()=>{const e=o.S.get().reset$.subscribe((()=>{t()}));return()=>e.unsubscribe()}),[t])}function h(){return(0,r.j)(o.S.get())}const u=()=>{const t=function(){const[t,e]=(0,i.useState)(h());return(0,i.useEffect)((()=>{const t=o.S.get().$.subscribe((()=>{e(h())}));return()=>t.unsubscribe()}),[]),t}();return(0,n.jsx)("span",{style:{whiteSpace:"nowrap"},children:t})}},1965:(t,e,s)=>{s.d(e,{M:()=>c});var n=s(864),i=s(7880),r=s(554),o=s(8177),a=s(7054);const c=t=>{let{className:e="",out:s,cmp:c,zeroState:u}=t;const l=i.lA.parse(s),p=i.lA.parse(c);if((0,a.dZ)(l))return(0,n.jsxs)("details",{children:[(0,n.jsx)("summary",{children:"Failed to parse output"}),(0,n.jsx)("pre",{children:(0,r.j)((0,a.UG)(l))}),(0,n.jsx)("code",{children:(0,n.jsx)("pre",{children:s})})]});if((0,a.dZ)(p))return(0,n.jsxs)("details",{children:[(0,n.jsx)("summary",{children:"Failed to parse compare"}),(0,n.jsxs)("code",{children:[(0,n.jsx)("pre",{children:(0,r.j)((0,a.UG)(p))}),(0,n.jsx)("pre",{children:c})]})]});const d=(0,a.Ok)(p),m=(0,a.Ok)(l);let g=0;const f=(0,o.w)(0,Math.min(d.length,m.length)).map((t=>{const e=d[t]??[],s=m[t]??[];return(0,o.w)(0,Math.max(e.length,s.length)).map(((t,n)=>[e[n]??"",s[n]??""])).map((t=>{let[e,s]=t;const n={cmp:e??'"',out:s??'"',pass:null!==e?.trim().match(/^\*+$/)||s?.trim()===e?.trim()};return n.pass||(g+=1),n}))}));return(0,n.jsxs)("div",{className:"scroll-x "+e,children:[g>0&&(0,n.jsxs)("p",{children:[g," failure",1===g?"":"s"]}),f.length>0?(0,n.jsx)("table",{style:{fontFamily:"var(--font-family-monospace)",marginBottom:"none"},children:(0,n.jsx)("tbody",{children:f.map(((t,e)=>(0,n.jsx)("tr",{children:t.map(((t,e)=>{let{cmp:s,out:i,pass:r}=t;return(0,n.jsx)(h,{cmp:s,out:i,pass:r},e)}))},e)))})}):u??(0,n.jsx)("p",{children:"Execute test script to compare output."})]})},h=t=>{let{cmp:e,out:s,pass:i}=t;return i?(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("td",{children:e})}):(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("td",{children:[(0,n.jsx)("ins",{children:e}),(0,n.jsx)("br",{}),(0,n.jsx)("del",{children:s})]})})}},554:(t,e,s)=>{s.d(e,{j:()=>n});const n=t=>{if((t=>"function"===typeof t?.toString||"string"===typeof t)(t)){const e=t.toString();return"[object Object]"===e?JSON.stringify(t):e}return JSON.stringify(t)}},2369:(t,e,s)=>{s.d(e,{Ff:()=>y,Jx:()=>b,Z9:()=>w,Zu:()=>r,aL:()=>v});var n=s(137),i=s(2201);function r(){return{A:0,D:0,PC:0,ALU:0,flag:n.vU.Zero}}const o=32768,a=36864,c=36864,h=36864,u=4032,l=32800,p=32784,d=32776,m=32769,g=32770,f=32772;function b(t){function e(e){return(t&e)===e}return{c:e(o),x1:e(a),x2:e(c),am:e(h),op:(t&u)>>6,d1:e(l),d2:e(p),d3:e(d),j1:e(m),j2:e(g),j3:e(f)}}function v(t,e){let{inM:s,instruction:i}=t,{A:r,D:o,PC:a}=e;const c=b(i),h=c.am?s:r,[u,l]=(0,n.Bb)(c.op,o,h);return[{A:r,D:o,PC:a+1,ALU:u,flag:l},c.d3]}function y(t,e){let{inM:s,instruction:i,reset:r}=t,{A:o,D:a,PC:c,ALU:h,flag:u}=e;const l=b(i),p=l.j1&&u===n.vU.Positive,d=l.j2&&u===n.vU.Zero,m=l.j3&&u===n.vU.Negative;c=r?0:p||d||m?o:c,l.d2&&(a=h);const g=o;l.c?l.d1&&(o=h):o=32767&i;const f=l.am?s:o,v=(0,n.Bb)(l.op,a,f);h=v[0],u=v[1];return[{addressM:l.d3?g:o,outM:h,writeM:l.d3},{A:o,D:a,ALU:h,flag:u,PC:c}]}class w{RAM;ROM;Screen;Keyboard;#t=0;#e=0;#s=0;#n={A:0,D:0,PC:0,ALU:0,flag:n.vU.Zero};get state(){return this.#n}get PC(){return this.#t}get A(){return this.#e}get D(){return this.#s}setA(t){this.#e=t}setD(t){this.#s=t}setPC(t){this.#t=t}constructor(t){let{RAM:e=new i.FH,ROM:s}=t;this.RAM=e,this.ROM=s,this.Screen=new i.kG(this.RAM,i.yJ,i.GD),this.Keyboard=new i.qT(this.RAM)}reset(){this.#t=0,this.#e=0,this.#s=0}tick(){const[{addressM:t,outM:e,writeM:s},{A:i,D:r,PC:o}]=function(t,e){const[s,n]=v(t,e);return y(t,s)}({inM:this.RAM.get(this.#e),instruction:this.ROM.get(this.#t),reset:!1},{A:this.#e,D:this.#s,PC:this.#t,ALU:this.#s,flag:n.vU.Zero});this.#e=i,this.#s=r,this.#t=o,s&&this.RAM.set(t,e)}}},7880:(t,e,s)=>{s.d(e,{lA:()=>c});var n=s(9814),i=s(3484);const r="\nCmp <: Base {\n  Root := line*\n  line = bar cell+ newline?\n  cell = cellvalue bar\n  cellvalue = (~(bar|newline) any)*\n}",o=n.Z.grammar(r,i.y1),a=o.extendSemantics(i.rJ);a.addAttribute("cell",{cell:(t,e)=>t.sourceString}),a.addAttribute("line",{line:(t,e,s)=>e.children.map((t=>t.cell))}),a.addAttribute("root",{Root:t=>t.children.map((t=>t.line))});const c={grammar:r,semantics:a,parser:o,parse:(0,i.Pz)(o,a)}},4430:(t,e,s)=>{s.d(e,{qH:()=>c});var n=s(9814),i=s(3484);const r='\nTst <: Base {\n  Root := Tst\n  Tst = (TstStatement | TstRepeat | TstWhile)+\n\n  TstRepeat = Repeat Number? OpenBrace TstStatement+ CloseBrace\n  TstWhile = While Condition OpenBrace TstStatement+ CloseBrace\n  TstStatement = List<TstOperation, ","> (Semi | Bang)\n\n  TstOperation =\n    | TstFileOperation\n    | TstOutputListOperation\n    | TstEvalOperation\n    | TstSetOperation\n    | TstOutputOperation\n    | TstEchoOperation\n    | TstClearEchoOperation\n    | TstLoadROMOperation\n\n  TstLoadROMOperation = ROM32K Load FileName\n  TstFileOperation = FileOperation FileName?\n  TstOutputListOperation = "output-list" OutputFormat+\n  OutputFormat = Name Index? percent FormatStyle wholeDec dot wholeDec dot wholeDec\n  TstSetOperation = Set Name Index? Number\n  Index = OpenSquare wholeDec? CloseSquare\n  Condition = Value CompareOp Value\n  TstEvalOperation = Eval | TickTock | Tick | Tock | VmStep\n  TstOutputOperation = Output\n  TstEchoOperation = Echo String\n  TstClearEchoOperation = ClearEcho\n\n  FileName = Name\n  FileOperation = "load" | "output-file" | "compare-to"\n\n  Set = "set"\n  Eval = "eval"\n  Tick = "tick"\n  Tock = "tock"\n  TickTock = "ticktock"\n  VmStep = "vmstep"\n  Echo = "echo"\n  Repeat = "repeat"\n  ClearEcho = "clear-echo"\n  Output = "output"\n  OutputList = "output-list"\n  FormatStyle = "B"|"D"|"S"|"X"\n  ROM32K = "ROM32K"\n  Load = "load"\n  While = "while"\n\n  CompareOp = "<>" | "<=" | ">=" | "=" | "<" | ">"\n}',o=n.Z.grammar(r,i.y1),a=o.extendSemantics(i.rJ);a.extendAttribute("value",{Index:(t,e,s)=>e?.child(0)?.value??-1}),a.extendAttribute("name",{FileName(t){let{name:e}=t;return e}}),a.addAttribute("index",{Index:(t,e,s)=>e.child(0)?.value??0}),a.addAttribute("format",{OutputFormat(t,e,s,n,i,r,o,a,c){let{name:h}=t,{sourceString:u}=n,{value:l}=i,{value:p}=o,{value:d}=c;return{id:h,builtin:void 0!==e?.child(0),address:e?.child(0)?.value??-1,style:u,width:p,lpad:l,rpad:d}}}),a.addAttribute("operation",{TstEvalOperation:t=>({op:t.sourceString}),TstOutputOperation:t=>({op:"output"}),TstOutputListOperation:(t,e)=>({op:"output-list",spec:e.children.map((t=>t.format))}),TstSetOperation(t,e,s,n){let{name:i}=e,{value:r}=n;const o={op:"set",id:i,value:r},a=s.child(0)?.child(1)?.child(0);return a&&(o.index=a.value),o},TstEchoOperation:(t,e)=>({op:"echo",message:e.String}),TstClearEchoOperation:t=>({op:"clear-echo"}),TstLoadROMOperation(t,e,s){let{name:n}=s;return{op:"loadRom",file:n}},TstFileOperation:(t,e)=>({op:t.sourceString,file:e?.sourceString})}),a.addAttribute("condition",{Condition(t,e,s){let{value:n}=t,{sourceString:i}=e,{value:r}=s;return{left:n,right:r,op:i}}}),a.addAttribute("statement",{TstWhile(t,e,s,n,r){return{statements:n.children.map((t=>{let{statement:e}=t;return e})),condition:e.condition,span:(0,i.yP)(this.source)}},TstRepeat(t,e,s,n,r){return{statements:n.children.map((t=>{let{statement:e}=t;return e})),count:e.child(0)?.value??-1,span:(0,i.yP)(this.source)}},TstStatement(t,e){const s={ops:t.asIteration().children.map((t=>t.operation)),span:(0,i.yP)(this.source)};return"!"===e.sourceString&&(s.break=!0),s}}),a.addAttribute("tst",{Tst:t=>({lines:t.children.map((t=>t.statement))})}),a.addAttribute("root",{Root(t){let{tst:e}=t;return e}});const c={grammar:r,semantics:a,parser:o,parse:(0,i.Pz)(o,a)}},8637:(t,e,s)=>{s.d(e,{VM:()=>c});var n=s(9814),i=s(3484);const r='\nVm <: Base {\n  Root := Vm\n\n  Vm = VmInstruction*\n\n  VmInstruction =\n    | StackInstruction\n    | OpInstruction\n    | FunctionInstruction\n    | CallInstruction\n    | ReturnInstruction\n    | GotoInstruction\n    | LabelInstruction\n  \n  StackInstruction = (Push | Pop) MemorySegment Number\n  OpInstruction = Add | Sub | Neg | Lt | Gt | Eq | And | Or | Not\n  FunctionInstruction = Function Name Number \n  CallInstruction =  Call Name Number\n  ReturnInstruction = Return\n  LabelInstruction = Label Name\n  GotoInstruction = (Goto | IfGoto) Name\n\n  MemorySegment = Argument | Local | Static | Constant | This | That | Pointer | Temp\n\n  Push = "push"\n  Pop = "pop"\n  Function = "function"\n  Call = "call"\n  Return = "return"\n  Goto = "goto"\n  IfGoto = "if-goto"\n  Label = "label"\n\n  Argument = "argument"\n  Local = "local"\n  Static = "static"\n  Constant = "constant"\n  This = "this"\n  That = "that"\n  Pointer = "pointer"\n  Temp = "temp"\n\n  Add = "add" \n  Sub = "sub" \n  Neg = "neg" \n  Eq = "eq"\n  Lt = "lt" \n  Gt = "gt" \n  And = "and" \n  Or = "or" \n  Not = "not"\n}',o=n.Z.grammar(r,i.y1),a=o.extendSemantics(i.rJ);a.addAttribute("op",{Push:t=>"push",Pop:t=>"pop",Function:t=>"function",Call:t=>"call",Return:t=>"return",Goto:t=>"goto",IfGoto:t=>"if-goto",Label:t=>"label",Add:t=>"add",Sub:t=>"sub",Neg:t=>"neg",Eq:t=>"eq",Lt:t=>"lt",Gt:t=>"gt",And:t=>"and",Or:t=>"or",Not:t=>"not"}),a.addAttribute("segment",{Argument:t=>"argument",Local:t=>"local",Static:t=>"static",Constant:t=>"constant",This:t=>"this",That:t=>"that",Pointer:t=>"pointer",Temp:t=>"temp"}),a.addAttribute("instruction",{StackInstruction(t,e,s){let{op:n}=t,{segment:i}=e,{value:r}=s;return{op:n,segment:i,offset:r}},OpInstruction(t){let{op:e}=t;return{op:e}},FunctionInstruction(t,e,s){let{name:n}=e,{value:i}=s;return{op:"function",name:n,nVars:i}},CallInstruction(t,e,s){let{name:n}=e,{value:i}=s;return{op:"call",name:n,nArgs:i}},ReturnInstruction:t=>({op:"return"}),LabelInstruction(t,e){let{name:s}=e;return{op:"label",label:s}},GotoInstruction(t,e){let{op:s}=t,{name:n}=e;return{op:s,label:n}}}),a.addAttribute("vm",{Vm:t=>({instructions:t.children.map((t=>t.instruction))})}),a.addAttribute("root",{Root(t){let{vm:e}=t;return e}});const c={grammar:r,semantics:a,parser:o,parse:(0,i.Pz)(o,a)}},9248:(t,e,s)=>{s.d(e,{h:()=>A});var n=s(7239),i=s(2836),r=s(5150);class o{variable;fmt;lPad;rPad;len;index;builtin;constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"%B1.1.1",s=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0,a=arguments.length>6?arguments[6]:void 0;if(this.variable=t,e.startsWith("%")&&void 0===s&&void 0===i&&void 0===r){const{fmt:t,lPad:s,rPad:n,len:i}=e.match(/^%(?<fmt>[BDXS])(?<lPad>\d+)\.(?<len>\d+)\.(?<rPad>\d+)$/)?.groups;this.fmt=t,this.lPad=parseInt(s),this.rPad=parseInt(n),this.len=parseInt(i),this.builtin=!1,this.index=-1}else(0,n.hu)(["B","X","D","S"].includes(e[0])),this.fmt=e[0],this.len=s??3,this.lPad=i??1,this.rPad=r??1,this.builtin=o??!1,this.index=a??-1}header(t){let e=`${this.variable}`;if(this.builtin){e=`${e}[${this.index>=0?this.index:""}]`}return e.length>this.len+this.lPad+this.rPad?e.substring(0,this.len+this.lPad+this.rPad):this.padCenter(e)}print(t){const e=t.getVar(this.variable,this.index);if("S"===this.fmt)return this.padLeft(e);const s=(0,{B:r.Ly,D:r.E_,X:r.$v}[this.fmt])(e);return"D"===this.fmt?this.padRight(s):this.padCenter(s.slice(s.length-this.len))}padCenter(t){const e=this.lPad+this.len+this.rPad,s=Math.floor((e-t.length)/2),n=e-s-t.length,i=s+t.length,r=i+n;return t=(t=t.padStart(i)).padEnd(r)}padLeft(t){t=t.substring(0,this.len);const e=this.rPad+this.len,s=this.lPad+e;return t=(t=t.padEnd(e)).padStart(s)}padRight(t){t=t.substring(0,this.len);const e=this.lPad+this.len,s=this.rPad+e;return t=(t=t.padStart(e)).padEnd(s)}}class a{variable;value;index;constructor(t,e,s){this.variable=t,this.value=e,this.index=s}do(t){t.setVar(this.variable,this.value,this.index)}*steps(){yield this}}class c{do(t){t.output()}*steps(){yield this}}class h{outputs=[];constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(const e of t)this.addOutput(e)}addOutput(t){this.outputs.push(new o(t.id,t.style,t.width,t.lpad,t.rpad,t.builtin,t.address))}do(t){t.outputList(this.outputs),t.header()}*steps(){yield this}}class u{instructions=[];span;addInstruction(t){this.instructions.push(t)}do(t){for(const e of this.instructions)e.do(t)}*steps(t){yield this}}class l extends u{repeat;constructor(t){super(),this.repeat=t}do(){}*innerSteps(t){for(const e of this.instructions)yield*e.steps(t)}*steps(t){if(-1===this.repeat)for(yield this;;)yield*this.innerSteps(t);else for(let e=0;e<this.repeat;e++)yield this,yield*this.innerSteps(t)}}class p{x;y;op;constructor(t,e,s){this.x=t,this.y=e,this.op=s}check(t){const e=t.hasVar(this.x)?t.getVar(this.x):this.x,s=t.hasVar(this.y)?t.getVar(this.y):this.y;if("string"===typeof e||"string"===typeof s)switch(this.op){case"=":return`${e}`===`${s}`;case"<>":return`${e}`!==`${s}`}else switch(this.op){case"<":return e<s;case"<=":return e<=s;case">":return e>s;case">=":return e>=s;case"=":return e===s;case"<>":return e!==s}return!1}}class d extends u{condition;constructor(t){super(),this.condition=t}*steps(t){for(;this.condition.check(t);){yield this;for(const e of this.instructions)yield*e.steps(t)}}}class m{content;constructor(t){this.content=t}do(t){t.echo(this.content)}*steps(){yield this}}class g{do(t){t.clearEcho()}*steps(){yield this}}class f{file;constructor(t){this.file=t}async do(t){t.fs.pushd("/samples"),await t.load(this.file),t.fs.popd()}*steps(){yield this}}var b=s(4388),v=s(1003);function y(t){return void 0!==t.ops}function w(t){return void 0!==t.condition}function S(t){const e=new u;e.span=t.span;for(const s of t.ops){const t=k(s);void 0!==t&&e.addInstruction(t)}return e}function k(t){const{op:e}=t;switch(e){case"tick":return new i.oK;case"tock":return new i.mL;case"ticktock":return new v.r;case"eval":return new i.Mb;case"vmstep":return new b.R;case"output":return new c;case"set":return new a(t.id,t.value,t.index);case"output-list":return new h(t.spec);case"echo":return new m(t.message);case"clear-echo":return new g;case"loadRom":return new f(t.file);case"load":case"output-file":case"compare-to":return;default:(0,n.qV)(e,`Unknown tst operation ${e}`)}}function A(t,e){for(const s of e.lines)if(y(s))t.addInstruction(S(s));else{const e=w(s)?new d(new p(s.condition.left,s.condition.right,s.condition.op)):new l(s.count);e.span=s.span,t.addInstruction(e);for(const t of s.statements)e.addInstruction(S(t))}return t.reset(),t}},2836:(t,e,s)=>{s.d(e,{Mb:()=>c,l1:()=>a,mL:()=>u,oK:()=>h});var n=s(5524),i=s(5424),r=s(9248),o=s(7468);class a extends o.e{chip=new n.P9;get chipId(){return this.chip.id}clock=i.S.get();static from(t){const e=new a;return(0,r.h)(e,t)}with(t){return this.chip=t,this}hasVar(t){return"time"===t||(t=`${t}`,this.chip.hasIn(t)||this.chip.hasOut(t))}getVar(t,e){if("time"===(t=`${t}`))return this.clock.toString();const s=this.chip.get(t,e);return s?s instanceof n.Gc?s.busVoltage:s.voltage():0}setVar(t,e,s){const i=this.chip.get(t,s);i instanceof n.Gc?i.busVoltage=e:i?.pull(0===e?n.yE:n.lj)}eval(){this.chip.eval()}tick(){this.chip.eval(),this.clock.tick()}tock(){this.chip.eval(),this.clock.tock()}async load(t){await this.chip.load(this.fs,t)}async run(){this.clock.reset(),await super.run()}}class c{_chipTestInstruction_=!0;do(t){t.eval()}*steps(){yield this}}class h{_chipTestInstruction_=!0;do(t){t.tick()}*steps(){yield this}}class u{_chipTestInstruction_=!0;do(t){t.tock()}*steps(){yield this}}},1003:(t,e,s)=>{s.d(e,{o:()=>a,r:()=>c});var n=s(2201),i=s(2369),r=s(7468),o=s(9248);class a extends r.e{cpu;ticks=0;static from(t,e){const s=new a(e);return(0,o.h)(s,t)}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new n.eD(new Int16Array);super(),this.cpu=new i.Z9({ROM:t}),this.reset()}reset(){return super.reset(),this.cpu.reset(),this.ticks=0,this}hasVar(t){return"number"!==typeof t&&!("A"!==t&&"D"!==t&&"PC"!==t&&"time"!==t&&!t.startsWith("RAM"))}getVar(t,e){switch(t){case"A":return this.cpu.A;case"D":return this.cpu.D;case"PC":return this.cpu.PC;case"time":return this.ticks;case"RAM":return void 0===e?0:this.cpu.RAM.get(e)}if("number"===typeof t)return 0;if(t.startsWith("RAM")){const e=Number(t.substring(4,t.length-1));return this.cpu.RAM.get(e)}return 0}setVar(t,e,s){switch(t){case"A":this.cpu.setA(e);break;case"D":this.cpu.setD(e);break;case"PC":this.cpu.setPC(e);break;case"RAM":this.cpu.RAM.set(s??0,e)}}ticktock(){this.ticks+=1,this.cpu.tick()}async load(t){await this.cpu.ROM.load(this.fs,t)}}class c{_cpuTestInstruction_=!0;do(t){t.ticktock()}*steps(){yield this}}},7468:(t,e,s)=>{s.d(e,{e:()=>r});var n=s(7239),i=s(2608);class r{instructions=[];_outputList=[];_log="";fs=new i.Wd;setFileSystem(t){return this.fs=t,this}echo(t){}clearEcho(){}async load(t){}async compareTo(t){}outputFile(t){}outputList(t){this._outputList=t}addInstruction(t){this.instructions.push(t)}reset(){return this._steps=function*(t){for(const e of t.instructions)yield*e.steps(t)}(this),this._step=this._steps.next(),this._log="",this}_steps;_step;get steps(){return void 0===this._steps&&(this.reset(),this._steps=(0,n.kP)(this._steps,"Reset did not initialize steps"),this._step=(0,n.kP)(this._step,"Reset did not find first step")),this._steps}get currentStep(){return this._step?.value}get done(){return this._step?.done??!1}step(){return!!this._step.done||(this._step.value.do(this),this._step=this.steps.next(),!1)}async run(){for(this.reset();!await this.step(););}breakpoints=new Map;addBreakpoint(t,e){this.breakpoints.set(t,e)}clearBreakpoints(){this.breakpoints.clear()}output(){const t=this._outputList.map((t=>t.print(this)));this._log+=`|${t.join("|")}|\n`}header(){const t=this._outputList.map((t=>t.header(this)));this._log+=`|${t.join("|")}|\n`}log(){return this._log}}},4388:(t,e,s)=>{s.d(e,{R:()=>u,w:()=>h});var n=s(7054),i=s(2201),r=s(8637),o=s(6391),a=s(9248),c=s(7468);class h extends c.e{vm=new o.Vm;static from(t){const e=new h;return(0,a.h)(e,t)}using(t){return this.fs=t,this}with(t){return this.vm=t,this}hasVar(t,e){return"string"!==typeof t&&(e=t,t="RAM"),"RAM"===t&&void 0!==e&&e>0&&e<i.FH.SIZE||["argument","local","static","constant","this","that","pointer","temp"].includes(t.toLowerCase())}getVar(t,e){return"string"!==typeof t&&(e=t,t="RAM"),"RAM"===t&&void 0!==e&&e>0&&e<i.FH.SIZE?this.vm.RAM.get(e):this.vm.memory.getSegment(t,e??0)}setVar(t,e,s){if("string"!==typeof t&&(s=t,t="RAM"),"RAM"===t&&void 0!==s&&s>0&&s<i.FH.SIZE&&this.vm.RAM.set(s,e),s)this.vm.memory.setSegment(t,s,e);else switch(t.toLowerCase()){case"sp":this.vm.memory.SP=e;break;case"arg":case"argument":this.vm.memory.ARG=e;break;case"lcl":case"local":this.vm.memory.LCL=e;break;case"this":this.vm.memory.THIS=e;break;case"that":this.vm.memory.THAT=e}}vmstep(){this.vm.step()}async load(t){if(t){const e=await this.fs.readFile(t),{instructions:s}=(0,n.Wg)(r.VM.parse(e));(0,n.Wg)(this.vm.load(s))}else for(const e of await this.fs.scandir("."))e.isFile()&&e.name.endsWith(".vm")&&await this.load(e.name);(0,n.Wg)(this.vm.bootstrap())}}class u{_vmTestInstruction_=!0;do(t){t.vmstep()}*steps(){yield this}}},6391:(t,e,s)=>{s.d(e,{Vm:()=>l});var n=s(7054),i=s(2201);class r extends i.FH{strict=!0;get SP(){return this.get(0)}set SP(t){this.set(0,t)}get LCL(){return this.get(1)}set LCL(t){this.set(1,t)}get ARG(){return this.get(2)}set ARG(t){this.set(2,t)}get THIS(){return this.get(3)}set THIS(t){this.set(3,t)}get THAT(){return this.get(4)}set THAT(t){this.set(4,t)}get statics(){const t=[];for(let e=16;e<256;e++)t.push(this.get(e));return t}constructor(){super(),this.set(0,256)}baseSegment(t,e){switch(t){case"argument":return this.ARG+e;case"constant":return e;case"local":return this.LCL+e;case"pointer":return this.pointer(e);case"static":return 16+e;case"temp":return 5+e;case"that":return this.THAT+e;case"this":return this.THIS+e}}getSegment(t,e){if("constant"===t)return e;const s=this.baseSegment(t,e);return this.get(s)}setSegment(t,e,s){const n=this.baseSegment(t,e);this.set(n,s)}argument(t){if(this.strict&&t<0)throw new Error(`Cannot access negative offsets: ${t}`);return this.get(this.ARG+t)}local(t){if(this.strict&&t<0)throw new Error(`Cannot access negative offsets: ${t}`);return this.get(this.LCL+t)}static(t){if(this.strict&&t<0)throw new Error(`Cannot access negative offsets: ${t}`);if(this.strict&&t>239)throw new Error(`Cannot access statics beyond 239: ${t}`);return this.get(16+t)}constant(t){return t}this(t){if(this.strict&&t<0)throw new Error(`Cannot access negative offsets: ${t}`);return this.get(this.THIS+t)}that(t){if(this.strict&&t<0)throw new Error(`Cannot access negative offsets: ${t}`);return this.get(this.THAT+t)}pointer(t){if(this.strict&&t<0)throw new Error(`Cannot access negative offsets: ${t}`);if(this.strict&&t>1)throw new Error(`pointer out of bounds access (pointer can be 0 for this, 1 for that, but got ${t}`);return 0===t?3:4}temp(t){if(this.strict&&t<0)throw new Error(`Cannot access negative offsets: ${t}`);if(this.strict&&t>7)throw new Error(`Temp out of bounds access (temp can be 0 to 7, but got ${t}`);return this.get(5+t)}push(t){const e=this.SP;this.set(e,t),this.set(0,e+1)}pop(){if(this.strict&&256===this.SP)throw new Error("Cannot pop the stack below 256 in strict mode");this.set(0,this.SP-1);return this.get(this.SP)}pushFrame(t,e,s){const n=this.SP,i=n-e;this.set(n,t),this.set(n+1,this.LCL),this.set(n+2,this.ARG),this.set(n+3,this.THIS),this.set(n+4,this.THAT),this.set(2,i),this.set(1,n+5);const r=n+5;for(let o=0;o<s;o++)this.set(r+1,0);return this.set(0,r+s),n}popFrame(){const t=this.LCL,e=this.get(t-5),s=this.pop();return this.set(this.ARG,s),this.set(0,this.ARG+1),this.set(4,this.get(t-1)),this.set(3,this.get(t-2)),this.set(2,this.get(t-3)),this.set(1,this.get(t-4)),e}getFrame(t,e,s,n,i,r){const o=t-e,a=t+5,c=a+s,h=r-c;return{args:{base:o,count:e,values:[...this.map(((t,e)=>e),o,o+e)]},locals:{base:a,count:s,values:[...this.map(((t,e)=>e),a,a+s)]},stack:{base:c,count:h,values:[...this.map(((t,e)=>e),c,c+h)]},this:{base:c,count:n,values:[...this.map(((t,e)=>e),this.THIS,this.THIS+n)]},that:{base:c,count:i,values:[...this.map(((t,e)=>e),this.THIS,this.THIS+i)]},frame:{RET:this.get(t),LCL:this.LCL,ARG:this.ARG,THIS:this.THIS,THAT:this.THAT}}}getVmState(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:240;const e=[...this.map(((t,e)=>e),5,13)],s=[...this.map(((t,e)=>e),13,16)],n=[...this.map(((t,e)=>e),16,16+t)];return{"0: SP":this.SP,"1: LCL":this.LCL,"2: ARG":this.ARG,"3: THIS":this.THIS,"4: THAT":this.THAT,temps:e,internal:s,static:n}}binOp(t){const e=65535&t(this.get(this.SP-2),this.get(this.SP-1));this.set(this.SP-2,e),this.set(0,this.SP-1)}unOp(t){const e=65535&t(this.get(this.SP-1));this.set(this.SP-1,e)}comp(t){this.binOp(((e,s)=>t(e,s)?-1:0))}}const o="__implicit",a="__bootstrap";function c(t){return{name:"__bootstrap",nVars:0,opBase:0,labels:{},operations:[{op:"function",name:"__bootstrap",nVars:0},{op:"call",name:t,nArgs:0}]}}const h="__END",u={name:"Sys.init",labels:{END:1},nVars:0,opBase:0,operations:[{op:"call",name:"main",nArgs:0},{op:"label",label:h},{op:"goto",label:h}]};class l{memory=new r;entry="";functionMap={};executionStack=[];functions=[];program=[];staticCount=0;statics={};registerStatic(t,e){const s=t.split(".")[0],n=this.statics[s]??[];this.statics[s]=n;const i=n[e]??this.staticCount++;return n[e]=i,i}registerStatics(){for(const t of Object.values(this.functionMap))for(const e of t.operations)["push","pop"].includes(e.op)&&"static"===e.segment&&(e.offset=this.registerStatic(t.name,e.offset))}static build(t){const e=new l,s=e.load(t);return(0,n.dZ)(s)?s:e.bootstrap()}static buildFunction(t,e){if("function"!==t[e].op)return(0,n.UG)(Error("Only call buildFunction at the initial Function instruction"));const{name:s,nVars:i}=t[e],r={name:s,nVars:i,labels:{},operations:[{op:"function",name:s,nVars:i}],opBase:0};e+=1;t:for(;e<t.length;){switch(t[e].op){case"function":break t;case"add":case"sub":case"neg":case"and":case"or":case"not":case"gt":case"lt":case"eq":r.operations.push({op:t[e].op});break;case"push":case"pop":r.operations.push({op:t[e].op,segment:t[e].segment,offset:t[e].offset});break;case"call":r.operations.push({op:"call",name:t[e].name,nArgs:t[e].nArgs});break;case"goto":case"if-goto":r.operations.push({op:t[e].op,label:t[e].label});break;case"label":{const{label:s}=t[e];if(r.labels[s])throw new Error(`Cannot redeclare label ${s} in function ${r.name} (previously at ${r.labels[s]})`);r.labels[s]=r.operations.length,r.operations.push({op:"label",label:s});break}case"return":r.operations.push({op:"return"})}e+=1}return r.name===o&&(r.labels[h]=r.operations.length,r.operations.push({op:"label",label:h}),r.operations.push({op:"goto",label:h})),(0,n.Ok)([r,e])}get RAM(){return this.memory}get Keyboard(){return this.memory.keyboard}get Screen(){return this.memory.screen}get invocation(){const t=this.executionStack.at(-1);if(void 0===t)throw new Error("Empty execution stack!");return t}get currentFunction(){const t=this.functionMap[this.invocation.function];if(void 0===t)throw new Error(`Executing undefined function ${this.invocation.function}`);return t}get operation(){if(this.invocation.opPtr>this.currentFunction.operations.length)throw new Error(`Current operation step beyond end of function operations (${this.invocation.opPtr} > ${this.currentFunction.operations.length})`);return this.currentFunction.operations[this.invocation.opPtr]}load(t){"function"!==t[0]?.op&&t.unshift({op:"function",name:o,nVars:0});let e=0;for(;e<t.length;){const s=l.buildFunction(t,e);if((0,n.dZ)(s))return(0,n.UG)(new Error("Failed to build VM",{cause:(0,n.UG)(s)}));const[i,r]=(0,n.Wg)(s);if(this.functionMap[i.name]&&this.memory.strict&&i.name!==o)return(0,n.UG)(new Error(`VM Already has a function named ${i.name}`));this.functionMap[i.name]=i,e=r}return this.registerStatics(),(0,n.Ok)(this)}bootstrap(){if(!this.functionMap[u.name]&&this.functionMap.main&&(this.functionMap[u.name]=u),this.functionMap[u.name])this.functionMap[a]=c(u.name),this.entry=a;else if(this.functionMap[o])this.entry=o;else{const t=Object.keys(this.functionMap);1===t.length&&(this.functionMap[a]=c(t[0]),this.entry=a)}if(this.functionMap[o]&&this.functionMap[a])return(0,n.UG)(new Error("Cannot use both bootstrap and an implicit function"));if(""===this.entry)return(0,n.UG)(Error("Could not determine an entry point for VM"));this.functions=Object.values(this.functionMap),this.functions.sort(((t,e)=>t.name===this.entry?-1:t.name===this.entry?1:0));let t=0;return this.program=this.functions.reduce(((e,s)=>(s.opBase=t,t+=s.operations.length,e.concat(s.operations))),[]),this.reset(),(0,n.Ok)(this)}reset(){this.executionStack=[{function:this.entry,opPtr:1,frameBase:256,nArgs:0}],this.memory.reset(),this.memory.set(0,256)}step(){const t=this.operation??{op:"return"};switch(t.op){case"push":{const e=this.memory.getSegment(t.segment,t.offset);this.memory.push(e);break}case"pop":{const e=this.memory.pop();this.memory.setSegment(t.segment,t.offset,e);break}case"add":this.memory.binOp(((t,e)=>t+e));break;case"sub":this.memory.binOp(((t,e)=>t-e));break;case"neg":this.memory.unOp((t=>-t));break;case"and":this.memory.binOp(((t,e)=>t&e));break;case"or":this.memory.binOp(((t,e)=>t|e));break;case"not":this.memory.unOp((t=>~t));break;case"eq":this.memory.comp(((t,e)=>t===e));break;case"lt":this.memory.comp(((t,e)=>t<e));break;case"gt":this.memory.comp(((t,e)=>t>e));break;case"goto":this.goto(t.label);break;case"if-goto":0!=this.memory.pop()&&this.goto(t.label);break;case"call":{const e=t.name,s=this.functionMap[e];if(!s)throw new Error(`Calling unknown function ${e}`);const n=this.memory.pushFrame(this.invocation.opPtr,t.nArgs,s.nVars);this.executionStack.push({function:e,opPtr:0,nArgs:t.nArgs,frameBase:n});break}case"return":{this.executionStack.pop();const t=this.memory.popFrame();this.invocation.opPtr=t;break}}this.invocation.opPtr+=1}goto(t){if(void 0===this.currentFunction.labels[t])throw new Error(`Attempting GOTO to unknown label ${t} in ${this.currentFunction.name}`);this.invocation.opPtr=this.currentFunction.labels[t]}write(t){t.map((t=>{let[e,s]=t;this.memory.set(e,s)}))}read(t){return t.map((t=>this.memory.get(t)))}vmStack(){return this.executionStack.map(((t,e)=>{const s=this.executionStack[e+1],n=s?s.frameBase-s.nArgs:this.memory.get(0);return this.makeFrame(t,n)}))}makeFrame(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.invocation,e=arguments.length>1?arguments[1]:void 0;const s=this.functionMap[t.function];if(["__implicit","__bootstrap"].includes(s.name)){const t=256,e=this.executionStack[1],n=e?e.frameBase-e.nArgs:this.memory.get(0);return{fn:s,args:{base:256,count:0,values:[]},locals:{base:256,count:0,values:[]},stack:{base:256,count:n-t,values:[...this.memory.map(((t,e)=>e),t,n)]},this:{base:0,count:0,values:[]},that:{base:0,count:0,values:[]},frame:{ARG:0,LCL:0,RET:0,THAT:0,THIS:0}}}const n=this.memory.getFrame(t.frameBase,t.nArgs,s.nVars,0,0,e);return n.fn=s,n}derivedLine(){return this.currentFunction.opBase+this.invocation.opPtr}writeDebug(){const t=this.derivedLine(),e=Math.max(t-5,0),s=Math.min(t+3,this.program.length),n=this.program.slice(e,s).map(((s,n)=>`${n===t-e?"->":"  "} ${function(t){switch(t.op){case"add":case"and":case"sub":case"eq":case"gt":case"lt":case"neg":case"not":case"or":case"return":return`  ${t.op}`;case"goto":return`  ${t.op}    ${t.label}`;case"if-goto":return`  ${t.op} ${t.label}`;case"label":return`${t.op}     ${t.label}`;case"call":return`  ${t.op}    ${t.name} ${t.nArgs}`;case"function":return`${t.op}  ${t.name} ${t.nVars}`;case"pop":return`  ${t.op}     ${t.segment} ${t.offset}`;case"push":return`  ${t.op}    ${t.segment} ${t.offset}`}}(s)}`)).join("\n"),i=this.vmStack().at(-1);return i?n+"\n\n"+function(t){return[`Frame: ${t.fn?.name??"Unknown Fn"} ARG:${t.frame.ARG} LCL:${t.frame.LCL}`,`Args: ${p(t.args)}`,`Lcls: ${p(t.locals)}`,`Stck: ${p(t.stack)}`].join("\n")}(i):n}}function p(t){return`[${t.base};${t.count}][${t.values.join(", ")}]`}}}]);